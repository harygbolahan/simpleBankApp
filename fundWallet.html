<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Responsive Admin &amp; Dashboard Template based on Bootstrap 5">
    <meta name="author" content="AdminKit">
    <meta name="keywords"
        content="adminkit, bootstrap, bootstrap 5, admin, dashboard, template, responsive, css, sass, html, theme, front-end, ui kit, web">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="shortcut icon" href="img/icons/icon-48x48.png" />

    <link rel="canonical" href="https://demo-basic.adminkit.io/pages-blank.html" />

    <title>Fund Wallet</title>

    <link href="css/app.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
</head>

<body>
    <div class="wrapper">
        <nav id="sidebar" class="sidebar js-sidebar">
			<div class="sidebar-content js-simplebar">
				<a class="sidebar-brand" href="dashboard.html">
					<span class="align-middle">Mabrook</span>
				</a>

				<ul class="sidebar-nav">
					<li class="sidebar-header">
						Pages
					</li>

					<li class="sidebar-item ">
						<a class="sidebar-link" href="dashboard.html">
							<i class="align-middle" data-feather="sliders"></i> <span
								class="align-middle">Dashboard</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="transferFunds.html">
							<i class="align-middle" data-feather="book"></i> <span class="align-middle">Transfer Funds</span>
						</a>
					</li>

					<li class="sidebar-item active ">
						<a class="sidebar-link" href="fundWallet.html">
							<i class="align-middle" data-feather="book"></i> <span class="align-middle">Fund Wallet</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="history.html">
							<i class="align-middle" data-feather="user"></i> <span class="align-middle"> History</span>
						</a>
					</li>

					
			</div>
		</nav>

        <div class="main">
            <nav class="navbar navbar-expand navbar-light navbar-bg">
				<a class="sidebar-toggle js-sidebar-toggle">
					<i class="hamburger align-self-center"></i>
				</a>

				<div class="navbar-collapse collapse">
					<ul class="navbar-nav navbar-align">
						<li class="nav-item dropdown">
							

						<li class="nav-item dropdown">
							<a class="nav-icon dropdown-toggle d-inline-block d-sm-none" href="#"
								data-bs-toggle="dropdown">
								<i class="align-middle" data-feather="settings"></i>
							</a>

							<a class="nav-link dropdown-toggle d-none d-sm-inline-block" href="#"
								data-bs-toggle="dropdown">
								<img src="img/avatars/avatar.jpg" class="avatar img-fluid rounded me-1"
									alt="Charles Hall" /> <span id="greetingName" class="text-dark"></span>
							</a>
							<div class="dropdown-menu dropdown-menu-end">
								
								<a class="dropdown-item" href="" id="signOutBTN">Log out</a>
							</div>
						</li>
					</ul>
				</div>
			</nav>

            <main class="content">
                <div class="container-fluid p-0">

                    <h1 class="h3 mb-3">Fund Wallet</h1>

                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Account Balance: â‚¦<span
                                            id="currentAccountBalance"> Loading...</span></h5>
                                </div>


                            </div>
                            <div class="card p-5 ">
                                <div>
                                    <p id="verifiedName"></p>
                                    <label for="emailAddress" class="form-label ">Email Address</label>
                                    <input type="email" class="form-control  " name="emailAddress" id="emailAddress">
                                    <!-- <a id="accountVerifyBTN" class="float-end btn btn-primary mt-2  ">Verify</a> -->
                                </div>


                                <label for="" class="form-label ">Amount to Fund</label>
                                <input type="number" id="amountToFund" class="form-control ">

                                <!-- <label for="narration" class="form-label mt-2 ">Narration</label>
                                    <input type="text" id="transferNarration" class="form-control "> -->
                                <button class="btn btn-success  m-3 " id="fundWalletBTN">Fund Wallet</button>
                            </div>

                        </div>
                    </div>

                    <!-- Recent Transaction -->
                    <div class="row">
                        <div>
                            <div class="card flex-fill">
                                <div class="card-header">

                                    <h5 class="card-title mb-0">Wallet Transactions</h5>
                                </div>
                                <table class="table table-hover my-0">
                                    <thead>
                                        <tr>
                                            <th>Serial Number</th>
                                            <th>User</th>
                                            <th>Amount</th>
                                            <th>Type</th>
                                            <th>Funded by</th>
                                            <th>Date & time</th>
                                        
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="walletTransactionsBody">

                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>


                </div>
            </main>

            <footer class="footer">
                <div class="container-fluid">
                    <div class="row text-muted">
                        <div class="col-6 text-start">
                            <p class="mb-0">
                                <a class="text-muted" href="https://adminkit.io/"
                                    target="_blank"><strong>AdminKit</strong></a> - <a class="text-muted"
                                    href="https://adminkit.io/" target="_blank"><strong>Bootstrap Admin
                                        Template</strong></a> &copy;
                            </p>
                        </div>
                        <div class="col-6 text-end">
                            <ul class="list-inline">
                                <li class="list-inline-item">
                                    <a class="text-muted" href="https://adminkit.io/" target="_blank">Support</a>
                                </li>
                                <li class="list-inline-item">
                                    <a class="text-muted" href="https://adminkit.io/" target="_blank">Help Center</a>
                                </li>
                                <li class="list-inline-item">
                                    <a class="text-muted" href="https://adminkit.io/" target="_blank">Privacy</a>
                                </li>
                                <li class="list-inline-item">
                                    <a class="text-muted" href="https://adminkit.io/" target="_blank">Terms</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </footer>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, updateDoc, doc, addDoc } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";


        const firebaseConfig = {
            apiKey: "AIzaSyBorT6AWCbJcUbKrHAFqzkFL4vYsnYWS7k",
            authDomain: "bankapp-9d509.firebaseapp.com",
            projectId: "bankapp-9d509",
            storageBucket: "bankapp-9d509.appspot.com",
            messagingSenderId: "1026193994379",
            appId: "1:1026193994379:web:52361708f33008c1a1da8e"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        //initialize getFirestore
        const db = getFirestore(app)
        const colRef = collection(db, 'usersDetails')
        const auth = getAuth()

        const greeting = document.getElementById("greeting");
        const greetingName = document.getElementById('greetingName')
        const signOutBTN = document.getElementById("signOutBTN");
        const accBalance = document.getElementById('currentAccountBalance')

        let currentUser



        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user
                try {
                    const q = query(colRef, where('email', '==', user.email));
                    const userDetails = await getDocs(q);
                    let userData = {};
                    userDetails.forEach(function (userDoc) {
                        userData = userDoc.data();
                    });
                    const { fullName, accountNo, bankName, accountBalance } = userData;
                    accBalance.innerHTML = accountBalance
                    // greetingName.innerHTML = fullName

                    // greeting.innerHTML = `
                    // Account Name: ${fullName || 'N/A'} <br>
                    // Account Number: ${accountNo || 'N/A'}<br>
                    // Bank Name: ${bankName || 'N/A'}<br>
                    // `;
                } catch (error) {
                    console.log(error);
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        signOutBTN.addEventListener('click', async () => {
            try {
                await signOut(auth)
                console.log('User has been signed out');
            } catch (error) {
                console.log(error);
            }
        });



        // Function to generate a unique serial number
        function generateSerialNumber() {
            const timestamp = Date.now().toString(); // Get current timestamp as string
            const randomNumber = Math.floor(Math.random() * 10000).toString().padStart(4, '0'); // Generate a random 4-digit number
            return timestamp + '-' + randomNumber; // Concatenate timestamp and random number
        }

        // Function to fund with paystack
        fundWalletBTN.addEventListener('click', async () => {
            let email = document.getElementById('emailAddress').value;
            let amount = +document.getElementById('amountToFund').value;

            console.log(email, amount);

            var handler = PaystackPop.setup({
                key: 'pk_test_04d149a29afa8a230c2135fd77eae481b3c5d1da', // Replace with your public key
                email: email,
                amount: amount * 100, // the amount value is multiplied by 100 to convert to the lowest currency unit
                currency: 'NGN', // Use GHS for Ghana Cedis or USD for US Dollars
                ref: '' + Math.floor((Math.random() * 1000000000) + 1), // Replace with a reference you generated
                callback: function (response) {
                    //this happens after the payment is completed successfully
                    var reference = response.reference;
                    alert('Payment complete! Reference: ' + reference);
                    console.log(response);

                    // Update user balance in Firebase
                    updateUserBalance(email, amount);
                },
                onClose: function () {
                    alert('Transaction was not completed, window closed.');
                },
            });
            handler.openIframe();
        });

        async function updateUserBalance(email, amount) {
            try {
                console.log(email, amount);
                const q = query(colRef, where('email', '==', email));
                const userDetails = await getDocs(q);
                userDetails.forEach(async function (userDoc) {
                    let userData = userDoc.data();
                    console.log('user data', userData);

                    let userID = userDoc.id;
                    let accountBalance = userData.accountBalance;
                    accountBalance += amount;

                    console.log(accountBalance);
                    console.log(userID);

                    await updateDoc(doc(colRef, userID), {
                        accountBalance: accountBalance
                    });

                    alert('Balance updated');

                    setTimeout(() => {
                        window.location.reload(); // Refresh the page after 5 seconds
                    }, 5000);

                    // Add transaction record
                    await addTransactionRecord(email, amount);
                });
            } catch (error) {
                console.error('Error updating user balance:', error);
            }
        }


        async function addTransactionRecord(email, amount) {
            try {
                const timestamp = new Date();
                const transactionData = {
                    email: email,
                    amount: amount,
                    transactionType: 'credit',
                    fundedBy: 'Self',
                    dateTime: timestamp.toLocaleString(),
                    status: 'success'
                };

                await addDoc(collection(db, 'fundingHistories'), transactionData);
                console.log('Transaction record added successfully');
            } catch (error) {
                console.error('Error adding transaction record:', error);
            }
        }

        // Function to fetch funding history transactions and display in table
        async function fetchAndDisplayTransactions() {

            try {
                let index = 0
                
                const querySnapshot = await getDocs(collection(db, 'fundingHistories'));
                const walletTransactionsBody = document.getElementById('walletTransactionsBody');
                walletTransactionsBody.innerHTML = ''; // Clear previous content
                console.log(currentUser.email, 'email');
                querySnapshot.forEach((doc) => {
                    const transactionData = doc.data();
                    let email = transactionData.email
                    if (currentUser.email === email) {
                        const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${++index}</td>
                <td>${transactionData.email}</td>
                <td>${transactionData.amount}</td>
                <td>${transactionData.transactionType}</td>
                <td>${transactionData.fundedBy}</td>
                <td>${transactionData.dateTime}</td>
                <td>${transactionData.status}</td>
            `;
                    walletTransactionsBody.appendChild(row);
                    }
                    
                });
            } catch (error) {
                console.error('Error fetching and displaying transactions:', error);
            }
        }

        // Call the function to fetch and display transactions
        fetchAndDisplayTransactions();



    </script>


</body>

</html>